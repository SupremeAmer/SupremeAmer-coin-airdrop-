<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>SupremeAmer Web3 Wallet</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap CSS for modern UI -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background: linear-gradient(135deg, #222 60%, #1e90ff 100%);
      color: #fff;
    }
    .wallet-card {
      background: rgba(0,0,0,0.8);
      border-radius: 16px;
      padding: 2rem;
      box-shadow: 0 8px 24px rgba(30,144,255,0.2);
      margin-top: 2rem;
    }
    .btn-primary {
      background: linear-gradient(90deg, #ff9800 10%, #1e90ff 100%);
      border: none;
    }
    .token-logo {
      width: 40px;
      vertical-align: middle;
      margin-right: 10px;
    }
    .tx-list {
      background: #222;
      border-radius: 12px;
      padding: 1rem;
      max-height: 300px;
      overflow-y: auto;
    }
  </style>
</head>
<body>
<div class="container">
  <div class="wallet-card mx-auto" style="max-width: 500px;">
    <h2 class="text-center mb-4">SupremeAmer Web3 Wallet</h2>
    <div class="mb-3">
      <button id="connectBtn" class="btn btn-primary w-100 mb-2">Connect Wallet</button>
      <button id="importBtn" class="btn btn-secondary w-100">Import Wallet (Phrase/Key)</button>
    </div>
    <div id="walletInfo" style="display:none;">
      <div class="mb-3">
        <strong>Address:</strong> <span id="userAddress"></span>
      </div>
      <div class="mb-3">
        <strong>ETH Balance:</strong> <span id="ethBalance"></span> ETH
      </div>
      <div class="mb-3">
        <img src="https://cryptologos.cc/logos/ethereum-eth-logo.png" class="token-logo"/>
        <strong>SupremeAmer Token:</strong>
        <span id="tokenBalance"></span> <span style="font-size:0.9em;color:#aaa;">(Mining Balance)</span>
      </div>
      <div class="mb-3">
        <label for="recipient" class="form-label">Send ETH</label>
        <input type="text" id="recipient" class="form-control mb-2" placeholder="Recipient Address">
        <input type="number" id="amount" class="form-control mb-2" placeholder="Amount in ETH" min="0" step="0.0001">
        <button id="sendBtn" class="btn btn-success w-100">Send (6% fee applied)</button>
      </div>
      <div class="mb-3">
        <button id="receiveBtn" class="btn btn-outline-info w-100">Show My Address / Receive</button>
        <div id="receiveSection" style="display:none;">
          <p>Your address (share to receive ETH/SupremeAmer):</p>
          <code id="myAddress"></code>
        </div>
      </div>
      <div class="mb-3">
        <h5>Transaction History</h5>
        <div class="tx-list" id="txHistory"></div>
      </div>
      <div class="mb-3" id="txNotifications"></div>
    </div>
  </div>
</div>

<!-- Libraries -->
<script src="https://cdn.jsdelivr.net/npm/ethers@5/dist/ethers.umd.min.js"></script>
<script src="https://unpkg.com/web3modal@1.9.12/dist/index.js"></script>
<script src="https://unpkg.com/@walletconnect/web3-provider@1.7.8/dist/umd/index.min.js"></script>
<script>
  <script>
const supremeamerToken = {
  address: '0xYourSupremeAmerTokenAddress', // TODO: Replace with your token address
  decimals: 18,
  symbol: 'SAMR'
};
// Replace with your Ethereum address (not an ENS/username!):
const UPGRADE_RECEIVER = '0xYourEthereumAddressHere'; // <--- PUT YOUR REAL ADDRESS HERE
const UPGRADE_USD = 9.5;

let provider, signer, userAddress, web3Modal;

// --- Initialize Web3Modal for multi-wallet support ---
function initWeb3Modal() {
  web3Modal = new window.Web3Modal.default({
    cacheProvider: false,
    providerOptions: {
      walletconnect: {
        package: window.WalletConnectProvider.default,
        options: {
          infuraId: "1c565a6d8f994bb89139d45ca26d5b0e" // Free Infura ID
        }
      }
    }
  });
}

async function connectWallet() {
  try {
    const instance = await web3Modal.connect();
    provider = new ethers.providers.Web3Provider(instance);
    signer = provider.getSigner();
    userAddress = await signer.getAddress();
    showWalletInfo();
    fetchBalances();
    fetchTransactionHistory();
    listenTxNotifications();
    // If upgrade pending, trigger upgrade purchase logic
    await maybeHandleUpgrade();
  } catch (e) {
    alert('Connection failed: ' + e.message);
    window.location.href = "index.html";
  }
}

// --- Import wallet via phrase/private key (not recommended for production) ---
async function importWallet() {
  const input = prompt("Enter your 12/24-word phrase or private key:");
  if (!input) return;
  try {
    let wallet;
    if (input.trim().split(' ').length >= 12) {
      wallet = ethers.Wallet.fromMnemonic(input.trim());
    } else {
      wallet = new ethers.Wallet(input.trim());
    }
    provider = ethers.getDefaultProvider('homestead'); // Ethereum mainnet
    signer = wallet.connect(provider);
    userAddress = await signer.getAddress();
    showWalletInfo();
    fetchBalances();
    fetchTransactionHistory();
    listenTxNotifications();
    await maybeHandleUpgrade();
  } catch (e) {
    alert('Import failed: ' + e.message);
    window.location.href = "index.html";
  }
}

// --- UI: Show wallet info section ---
function showWalletInfo() {
  document.getElementById('connectBtn').style.display = 'none';
  document.getElementById('importBtn').style.display = 'none';
  document.getElementById('walletInfo').style.display = 'block';
  document.getElementById('userAddress').textContent = userAddress;
  document.getElementById('myAddress').textContent = userAddress;
}

// --- Fetch ETH and token balances ---
async function fetchBalances() {
  // ETH balance
  const balance = await provider.getBalance(userAddress);
  document.getElementById('ethBalance').textContent = ethers.utils.formatEther(balance);

  // SupremeAmer Token balance
  const tokenAbi = [
    "function balanceOf(address) view returns (uint256)",
    "function miningBalance(address) view returns (uint256)"
  ];
  const token = new ethers.Contract(supremeamerToken.address, tokenAbi, provider);
  let tokenBalance = await token.balanceOf(userAddress);
  let miningBalance = 0;
  // If miningBalance is a custom function in your contract, try to fetch it
  try {
    miningBalance = await token.miningBalance(userAddress);
  } catch {}
  document.getElementById('tokenBalance').textContent = `${ethers.utils.formatUnits(tokenBalance, supremeamerToken.decimals)} (+Mining: ${ethers.utils.formatUnits(miningBalance, supremeamerToken.decimals)})`;
}

// --- Send ETH with 6% fee ---
document.getElementById('sendBtn').onclick = async function() {
  const to = document.getElementById('recipient').value.trim();
  let amount = Number(document.getElementById('amount').value);
  if (!ethers.utils.isAddress(to)) return alert('Invalid recipient address');
  if (!amount || amount <= 0) return alert('Amount must be positive');
  try {
    // Calculate 6% fee
    const totalWei = ethers.utils.parseEther(amount.toString());
    const feeWei = totalWei.mul(6).div(100);
    const sendWei = totalWei.sub(feeWei);

    // Send 94% to recipient
    let tx1 = await signer.sendTransaction({ to, value: sendWei });
    // Send 6% fee to fee address
    let tx2 = await signer.sendTransaction({ to: UPGRADE_RECEIVER, value: feeWei }); // can use fee receiver address
    alert('Transaction sent!');

    fetchBalances();
    fetchTransactionHistory();
  } catch (e) {
    alert('Transaction failed: ' + e.message);
  }
};

// --- Show receive address ---
document.getElementById('receiveBtn').onclick = function() {
  let el = document.getElementById('receiveSection');
  el.style.display = el.style.display === 'none' ? 'block' : 'none';
};

// --- Fetch transaction history (ETH only, for brevity) ---
async function fetchTransactionHistory() {
  const api = `https://api.etherscan.io/api?module=account&action=txlist&address=${userAddress}&sort=desc&apikey=YourApiKeyToken`;
  const res = await fetch(api);
  const data = await res.json();
  if (data.status !== "1") return;
  const txs = data.result.slice(0, 10); // last 10 txs
  let html = txs.map(tx => `
    <div>
      <small>${new Date(tx.timeStamp * 1000).toLocaleString()}</small><br>
      <b>${tx.from.toLowerCase() === userAddress.toLowerCase() ? "Sent" : "Received"}:</b>
      <span>${ethers.utils.formatEther(tx.value)} ETH</span>
      <br>
      <a href="https://etherscan.io/tx/${tx.hash}" target="_blank" style="color:#1e90ff">View</a>
    </div>
  `).join('<hr>');
  document.getElementById('txHistory').innerHTML = html;
}

// --- Transaction notifications (basic) ---
function listenTxNotifications() {
  provider.on('block', async (blockNumber) => {
    fetchTransactionHistory();
    document.getElementById('txNotifications').innerHTML = `<span class="badge bg-success">New block: ${blockNumber}. Transaction history updated.</span>`;
    setTimeout(() => document.getElementById('txNotifications').innerHTML = '', 5000);
  });
}

/* --- MINING UPGRADE DEDUCTION LOGIC --- */
async function maybeHandleUpgrade() {
  const urlParams = new URLSearchParams(window.location.search);
  if (localStorage.getItem('pendingUpgrade') === 'true' && urlParams.get('upgrade') === 'speed') {
    // Prompt user
    if (!confirm(`Do you want to pay $9.5 worth of ETH (current rate) for the mining speed upgrade?`)) {
      localStorage.setItem('upgradeCancelled', 'true');
      localStorage.removeItem('pendingUpgrade');
      window.location.href = "index.html";
      return;
    }
    try {
      // 1. Fetch ETH/USD price (CoinGecko API, no key needed)
      const res = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=ethereum&vs_currencies=usd');
      const data = await res.json();
      const ethusd = data.ethereum.usd;
      const ethAmount = (UPGRADE_USD / ethusd).toFixed(6); // 6 decimals
      // 2. Send the ETH
      const tx = await signer.sendTransaction({
        to: UPGRADE_RECEIVER,
        value: ethers.utils.parseEther(ethAmount)
      });
      alert(`Transaction sent!\nHash: ${tx.hash}\nWaiting for confirmation...`);
      await tx.wait();
      // 3. Set upgradePurchased & redirect
      localStorage.setItem('upgradePurchased', 'true');
      localStorage.removeItem('pendingUpgrade');
      window.location.href = "index.html";
    } catch (e) {
      alert('Transaction failed or rejected: ' + e.message);
      localStorage.setItem('upgradeCancelled', 'true');
      localStorage.removeItem('pendingUpgrade');
      window.location.href = "index.html";
    }
  }
}

// --- Startup ---
initWeb3Modal();
document.getElementById('connectBtn').onclick = connectWallet;
document.getElementById('importBtn').onclick = importWallet;

// If already connected (e.g., MetaMask injected), check upgrade immediately
window.addEventListener('DOMContentLoaded', async () => {
  const urlParams = new URLSearchParams(window.location.search);
  if (localStorage.getItem('pendingUpgrade') === 'true' && urlParams.get('upgrade') === 'speed') {
    // If user has already connected wallet
    try {
      if (window.ethereum) {
        provider = new ethers.providers.Web3Provider(window.ethereum);
        signer = provider.getSigner();
        userAddress = await signer.getAddress();
        await maybeHandleUpgrade();
      }
    } catch {}
  }
});
</script>
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>SupremeAmer Wallet</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/web3@1.8.0/dist/web3.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@walletconnect/web3-provider@1.7.8/dist/umd/index.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <style>
    :root {
      --primary-color: #ff9800;
      --secondary-color: #fdc500;
      --accent-color: #ff3333;
      --dark-bg: #101010;
      --card-bg: #1e1e28;
      --text-light: #ffffff;
      --text-dark: #333333;
    }
    
    body {
      background: var(--dark-bg);
      color: var(--text-light);
      font-family: 'Montserrat', 'Segoe UI', Arial, sans-serif;
      margin: 0;
      min-height: 100vh;
    }
    
    header {
      background: linear-gradient(135deg, #111 70%, var(--primary-color) 100%);
      color: var(--text-light);
      padding: 12px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      box-shadow: 0 2px 16px rgba(255, 235, 59, 0.2);
    }
    
    .logo {
      height: 40px;
      margin-right: 16px;
    }
    
    nav {
      display: flex;
      gap: 10px;
      margin-left: 32px;
    }
    
    nav button {
      background: rgba(0,0,0,0.3);
      color: var(--text-light);
      border: none;
      margin: 0 4px;
      padding: 10px 18px;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      font-weight: 600;
    }
    
    nav button:hover,
    nav button.active {
      background: var(--primary-color);
      color: var(--text-dark);
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(255, 152, 0, 0.3);
    }
    
    main {
      padding: 24px;
      min-height: 400px;
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .card {
      background: var(--card-bg);
      color: var(--text-light);
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(41,121,255,0.07);
      margin-bottom: 18px;
      padding: 18px;
      transition: all 0.3s;
    }
    
    .card:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 16px rgba(255, 152, 0, 0.2);
    }
    
    input, select, textarea {
      padding: 12px;
      border-radius: 6px;
      border: 1px solid var(--primary-color);
      margin-bottom: 10px;
      width: 100%;
      box-sizing: border-box;
      background: rgba(0,0,0,0.3);
      color: var(--text-light);
    }
    
    button.action {
      background: linear-gradient(90deg, var(--secondary-color) 40%, var(--primary-color) 100%);
      color: var(--text-dark);
      border: none;
      border-radius: 6px;
      padding: 12px 24px;
      margin-top: 8px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.2s;
      box-shadow: 0 4px 8px rgba(255, 152, 0, 0.3);
    }
    
    button.action:hover {
      background: linear-gradient(90deg, var(--primary-color) 40%, var(--secondary-color) 100%);
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(255, 152, 0, 0.4);
    }
    
    hr {
      border: 0;
      border-top: 1px solid var(--primary-color);
      margin: 16px 0;
      opacity: 0.3;
    }
    
    .token-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      padding: 8px;
      border-radius: 6px;
      transition: all 0.2s;
    }
    
    .token-row:hover {
      background: rgba(255, 152, 0, 0.1);
    }
    
    .balance {
      font-weight: bold;
      color: var(--secondary-color);
    }
    
    .mining-status {
      padding: 8px;
      border-radius: 6px;
      background: rgba(0,0,0,0.3);
      margin-top: 10px;
      font-size: 0.9em;
    }
    
    .mining-active {
      color: #4CAF50;
    }
    
    .mining-inactive {
      color: var(--accent-color);
    }
    
    .progress-container {
      width: 100%;
      height: 8px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
      margin: 10px 0;
      overflow: hidden;
    }
    
    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--secondary-color), var(--primary-color));
      border-radius: 4px;
      transition: width 0.3s;
    }
    
    /* Notification */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #333;
      color: #fff;
      padding: 15px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      z-index: 2000;
      transform: translateX(200%);
      transition: transform 0.3s;
      display: flex;
      align-items: center;
    }
    
    .notification.show {
      transform: translateX(0);
    }
    
    .notification.success {
      background: #4CAF50;
    }
    
    .notification.error {
      background: var(--accent-color);
    }
    
    .notification i {
      margin-right: 10px;
      font-size: 1.2em;
    }
    
    /* Mining Dashboard */
    .mining-dashboard {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
    }
    
    .mining-card {
      flex: 1;
      min-width: 300px;
    }
    
    /* QR Code */
    .qr-container {
      display: flex;
      justify-content: center;
      padding: 20px;
      background: white;
      border-radius: 8px;
      margin: 10px 0;
    }
    
    /* Wallet Connection Status */
    .connection-status {
      display: flex;
      align-items: center;
      padding: 8px 12px;
      border-radius: 20px;
      background: rgba(0,0,0,0.3);
      margin-left: auto;
    }
    
    .connection-status.connected {
      background: rgba(76, 175, 80, 0.2);
      color: #4CAF50;
    }
    
    .connection-status.disconnected {
      background: rgba(244, 67, 54, 0.2);
      color: var(--accent-color);
    }
    
    .connection-status i {
      margin-right: 6px;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      header {
        flex-direction: column;
        align-items: flex-start;
      }
      
      nav {
        margin-top: 12px;
        margin-left: 0;
        width: 100%;
        justify-content: space-between;
      }
      
      nav button {
        padding: 8px 12px;
        font-size: 0.9em;
      }
      
      main {
        padding: 12px;
      }
      
      .mining-dashboard {
        flex-direction: column;
      }
      
      .connection-status {
        margin-top: 10px;
        margin-left: 0;
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <!-- Notification System -->
  <div id="notification" class="notification">
    <i class="fas fa-check-circle"></i>
    <span id="notificationText">Notification message</span>
  </div>
  
  <header>
    <div style="display:flex; align-items:center;">
      <img src="supremeamer_coin.png" alt="SupremeAmer Wallet Logo" class="logo">
      <h1>SupremeAmer Wallet</h1>
    </div>
    <div id="connection-status" class="connection-status disconnected">
      <i class="fas fa-plug"></i>
      <span>Disconnected</span>
    </div>
    <nav>
      <button id="nav-home" class="active"><i class="fas fa-home"></i> Home</button>
      <button id="nav-mining"><i class="fas fa-digging"></i> Mining</button>
      <button id="nav-staking"><i class="fas fa-coins"></i> Staking</button>
      <button id="nav-dex"><i class="fas fa-exchange-alt"></i> DEX</button>
      <button id="nav-connect"><i class="fas fa-plug"></i> Connect</button>
      <button id="nav-settings"><i class="fas fa-cog"></i> Settings</button>
    </nav>
  </header>
  
  <main id="main-content">
    <!-- Content will be dynamically loaded here -->
  </main>
  
  <script>
    // Supported tokens and contract addresses (BSC Mainnet)
    const TOKEN_LIST = [
      { 
        symbol: 'BNB', 
        name: 'Binance Coin', 
        contract: 'BNB',
        decimals: 18,
        logo: 'https://cryptologos.cc/logos/bnb-bnb-logo.png'
      },
      { 
        symbol: 'SA', 
        name: 'SupremeAmer Coin', 
        contract: '0xdd9fd6b6f8f7ea932997992bbe67eabb3e316f3c',
        decimals: 18,
        logo: 'https://supremeamer.com/logo.png'
      },
      { 
        symbol: 'USDT', 
        name: 'Tether USD (BEP-20)', 
        contract: '0x55d398326f99059fF775485246999027B3197955',
        decimals: 18,
        logo: 'https://cryptologos.cc/logos/tether-usdt-logo.png'
      },
      { 
        symbol: 'USDC', 
        name: 'USD Coin (BEP-20)', 
        contract: '0x8AC76a51cc950d9822D68b83fE1Ad97B32Cd580d',
        decimals: 18,
        logo: 'https://cryptologos.cc/logos/usd-coin-usdc-logo.png'
      },
      { 
        symbol: 'BUSD', 
        name: 'Binance USD', 
        contract: '0xe9e7CEA3DedcA5984780Bafc599bD69ADd087D56',
        decimals: 18,
        logo: 'https://cryptologos.cc/logos/binance-usd-busd-logo.png'
      }
    ];

    // State
    let wallets = JSON.parse(localStorage.getItem('supremeamer_wallets') || '[]');
    let activeWallet = wallets[0] || null;
    let minedCoins = parseFloat(localStorage.getItem('minedCoins') || '0');
    let miningActive = false;
    let miningInterval = null;
    let miningSpeed = 0.0002; // Default mining speed (SA per second)
    let tokenPrices = {};
    let tokenBalances = {};
    let web3;
    let provider;
    let walletConnectProvider;
    let currentAccount = null;
    let currentNetwork = null;
    
    // Initialize Web3 and check connection on load
    window.onload = async () => {
      showSection('home');
      loadMiningState();
      
      // Check if we have mining data from the game
      if (localStorage.getItem('minedCoins')) {
        minedCoins = parseFloat(localStorage.getItem('minedCoins'));
      }
      
      // Initialize mining if active
      if (localStorage.getItem('miningActive') === 'true') {
        startMining();
      }
      
      // Initialize Web3
      initWeb3();
      
      // Load token prices
      await fetchTokenPrices();
      
      // If we have a connected wallet in localStorage, try to reconnect
      const savedWallet = localStorage.getItem('connectedWallet');
      if (savedWallet) {
        if (savedWallet === 'metamask') {
          await connectMetaMask();
        } else if (savedWallet === 'walletconnect') {
          await initWalletConnect();
        }
      }
    };

    // Navigation
    const navButtons = [
      'nav-home',
      'nav-mining',
      'nav-staking',
      'nav-dex',
      'nav-connect',
      'nav-settings'
    ];

    navButtons.forEach(id => {
      document.getElementById(id).addEventListener('click', () => {
        navButtons.forEach(btn => document.getElementById(btn).classList.remove('active'));
        document.getElementById(id).classList.add('active');
        showSection(id.replace('nav-', ''));
      });
    });

    function showNotification(message, type = 'info', duration = 3000) {
      const notification = document.getElementById('notification');
      const notificationText = document.getElementById('notificationText');
      
      notificationText.textContent = message;
      notification.className = 'notification';
      
      // Add type class
      if (type === 'success') {
        notification.classList.add('success');
        notification.querySelector('i').className = 'fas fa-check-circle';
      } else if (type === 'error') {
        notification.classList.add('error');
        notification.querySelector('i').className = 'fas fa-exclamation-circle';
      } else {
        notification.querySelector('i').className = 'fas fa-info-circle';
      }
      
      // Show notification
      notification.classList.add('show');
      
      // Hide after duration
      setTimeout(() => {
        notification.classList.remove('show');
      }, duration);
    }

    function showSection(section) {
      const main = document.getElementById('main-content');
      
      if (section === 'home') {
        main.innerHTML = `
          <div class="mining-dashboard">
            <div class="card mining-card">
              <h2><i class="fas fa-wallet"></i> Your Wallets</h2>
              <div id="wallets-list"></div>
              ${wallets.length < 3 ? `
              <button class="action" onclick="createWalletUI()"><i class="fas fa-plus"></i> Create Wallet</button>
              <button class="action" onclick="importWalletUI()"><i class="fas fa-file-import"></i> Import Wallet</button>
              ` : '<div>Max 3 wallets reached.</div>'}
            </div>
            
            <div class="card mining-card">
              <h2><i class="fas fa-coins"></i> Assets</h2>
              <div id="assets-list"></div>
            </div>
          </div>
          
          <div class="card">
            <h2><i class="fas fa-digging"></i> Mining Status</h2>
            <div id="mining-status-display"></div>
            <button class="action" onclick="startMining()" id="mining-toggle-btn">
              <i class="fas fa-power-off"></i> Start Mining
            </button>
            <div class="progress-container">
              <div class="progress-bar" id="mining-progress"></div>
            </div>
            <div class="mining-status" id="mining-stats">
              Mined: ${minedCoins.toFixed(4)} SA | Speed: ${miningSpeed} SA/sec
            </div>
            ${currentAccount ? `
            <button class="action" onclick="withdrawMinedTokens()">
              <i class="fas fa-hand-holding-usd"></i> Withdraw to ${currentAccount.substring(0,6)}...${currentAccount.substring(38)}
            </button>
            ` : ''}
          </div>
        `;
        renderWallets();
        renderAssets();
        updateMiningUI();
      } 
      else if (section === 'mining') {
        main.innerHTML = `
          <div class="card">
            <h2><i class="fas fa-digging"></i> SupremeAmer Mining</h2>
            <p>Earn SA tokens by keeping the mining active. The longer you mine, the more you earn!</p>
            
            <div class="token-row">
              <div>
                <h3>Your Mining Stats</h3>
                <div id="mining-stats-display"></div>
              </div>
              <div class="balance">
                ${minedCoins.toFixed(4)} SA
              </div>
            </div>
            
            <div class="progress-container">
              <div class="progress-bar" id="mining-progress-full"></div>
            </div>
            
            <button class="action" onclick="startMining()" id="mining-toggle-btn-full">
              <i class="fas fa-power-off"></i> Start Mining
            </button>
            
            ${currentAccount ? `
            <button class="action" onclick="withdrawMinedTokens()">
              <i class="fas fa-hand-holding-usd"></i> Withdraw to ${currentAccount.substring(0,6)}...${currentAccount.substring(38)}
            </button>
            ` : ''}
            
            <div id="mining-upgrade-section"></div>
          </div>
        `;
        updateMiningStats();
      }
      else if (section === 'staking') {
        main.innerHTML = `
          <div class="card">
            <h2><i class="fas fa-coins"></i> Staking</h2>
            <div id="staking-form"></div>
            <div id="staking-summary"></div>
          </div>
        `;
        renderStakingForm();
      } 
      else if (section === 'dex') {
        main.innerHTML = `
          <div class="card">
            <h2><i class="fas fa-exchange-alt"></i> PancakeSwap DEX</h2>
            <p>Swap your SA tokens with other cryptocurrencies</p>
            <div id="dex-form"></div>
          </div>
        `;
        renderDexForm();
      } 
      else if (section === 'connect') {
        main.innerHTML = `
          <div class="card">
            <h2><i class="fas fa-plug"></i> Wallet Connection</h2>
            <p>Connect your wallet to manage assets and withdraw mined tokens</p>
            
            <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 20px;">
              <button class="action" onclick="connectMetaMask()" style="display: flex; align-items: center; justify-content: center;">
                <img src="https://upload.wikimedia.org/wikipedia/commons/3/36/MetaMask_Fox.svg" style="width: 24px; margin-right: 10px;">
                Connect MetaMask
              </button>
              
              <button class="action" onclick="initWalletConnect()" style="display: flex; align-items: center; justify-content: center;">
                <img src="https://registry.walletconnect.com/api/v1/logo/md/7a33d7f1-3d12-4b5c-f3ee-5cd83cb1b500" style="width: 24px; margin-right: 10px;">
                WalletConnect
              </button>
              
              <button class="action" onclick="disconnectWallet()" style="background: var(--accent-color);">
                <i class="fas fa-plug"></i> Disconnect Wallet
              </button>
            </div>
            
            ${currentAccount ? `
            <div class="card" style="margin-top: 20px;">
              <h3>Connected Wallet</h3>
              <p><strong>Address:</strong> ${currentAccount}</p>
              <p><strong>Network:</strong> ${currentNetwork || 'Not connected'}</p>
              
              <div class="qr-container">
                <canvas id="address-qr-code"></canvas>
              </div>
              
              <button class="action" onclick="copyToClipboard(currentAccount)">
                <i class="fas fa-copy"></i> Copy Address
              </button>
            </div>
            ` : ''}
          </div>
        `;
        
        if (currentAccount) {
          // Generate QR code for the connected address
          setTimeout(() => {
            new QRCode(document.getElementById('address-qr-code'), {
              text: currentAccount,
              width: 150,
              height: 150,
              colorDark: "#000000",
              colorLight: "#ffffff",
              correctLevel: QRCode.CorrectLevel.H
            });
          }, 100);
        }
      } 
      else if (section === 'settings') {
        main.innerHTML = `
          <div class="card">
            <h2><i class="fas fa-cog"></i> Settings</h2>
            <button class="action" onclick="setPINUI()">
              <i class="fas fa-lock"></i> Set/Change PIN
            </button>
            <button class="action" onclick="backupCloudUI()">
              <i class="fas fa-cloud-upload-alt"></i> Backup to Cloud
            </button>
            <button class="action" onclick="exportSeedUI()">
              <i class="fas fa-key"></i> Export Seed Phrase
            </button>
          </div>
        `;
      }
    }

    // Initialize Web3
    function initWeb3() {
      if (window.ethereum) {
        provider = window.ethereum;
        web3 = new Web3(provider);
        
        // Listen for account changes
        window.ethereum.on('accountsChanged', (accounts) => {
          if (accounts.length === 0) {
            // Wallet disconnected
            disconnectWallet();
          } else {
            currentAccount = accounts[0];
            updateConnectionStatus();
            fetchBalances();
            showSection('home');
          }
        });
        
        // Listen for chain changes
        window.ethereum.on('chainChanged', (chainId) => {
          currentNetwork = getNetworkName(chainId);
          updateConnectionStatus();
          fetchBalances();
          showNotification(`Switched to ${currentNetwork}`, 'info');
        });
      } else {
        console.log('No Ethereum provider detected');
      }
    }

    // Initialize WalletConnect
    async function initWalletConnect() {
      try {
        // Initialize WalletConnect provider
        walletConnectProvider = new WalletConnectProvider.default({
          rpc: {
            56: "https://bsc-dataseed.binance.org/", // BSC Mainnet
            97: "https://data-seed-prebsc-1-s1.binance.org:8545/" // BSC Testnet
          },
          chainId: 56 // Default to BSC Mainnet
        });
        
        // Enable session (triggers QR Code modal)
        await walletConnectProvider.enable();
        
        // Create Web3 instance
        web3 = new Web3(walletConnectProvider);
        
        // Get accounts
        const accounts = await web3.eth.getAccounts();
        currentAccount = accounts[0];
        
        // Get chain ID
        const chainId = await web3.eth.getChainId();
        currentNetwork = getNetworkName(chainId);
        
        // Save connection
        localStorage.setItem('connectedWallet', 'walletconnect');
        updateConnectionStatus();
        fetchBalances();
        showNotification("WalletConnect connected successfully!", "success");
        showSection('home');
        
        // Subscribe to events
        walletConnectProvider.on("accountsChanged", (accounts) => {
          if (accounts.length === 0) {
            disconnectWallet();
          } else {
            currentAccount = accounts[0];
            updateConnectionStatus();
            fetchBalances();
          }
        });
        
        walletConnectProvider.on("chainChanged", (chainId) => {
          currentNetwork = getNetworkName(chainId);
          updateConnectionStatus();
          fetchBalances();
        });
        
        walletConnectProvider.on("disconnect", () => {
          disconnectWallet();
        });
        
      } catch (error) {
        console.error("WalletConnect error:", error);
        showNotification("Failed to connect with WalletConnect", "error");
      }
    }

    // Connect MetaMask
    async function connectMetaMask() {
      try {
        if (!window.ethereum) {
          showNotification("MetaMask not installed", "error");
          return;
        }
        
        // Request account access
        const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
        currentAccount = accounts[0];
        
        // Get chain ID
        const chainId = await web3.eth.getChainId();
        currentNetwork = getNetworkName(chainId);
        
        // Save connection
        localStorage.setItem('connectedWallet', 'metamask');
        updateConnectionStatus();
        fetchBalances();
        showNotification("MetaMask connected successfully!", "success");
        showSection('home');
        
      } catch (error) {
        console.error("MetaMask connection error:", error);
        showNotification("Failed to connect MetaMask", "error");
      }
    }

    // Disconnect wallet
    function disconnectWallet() {
      if (walletConnectProvider) {
        walletConnectProvider.disconnect();
        walletConnectProvider = null;
      }
      
      currentAccount = null;
      currentNetwork = null;
      web3 = null;
      provider = null;
      
      localStorage.removeItem('connectedWallet');
      updateConnectionStatus();
      showNotification("Wallet disconnected", "info");
      showSection('connect');
    }

    // Update connection status UI
    function updateConnectionStatus() {
      const statusEl = document.getElementById('connection-status');
      
      if (currentAccount) {
        statusEl.className = 'connection-status connected';
        statusEl.innerHTML = `
          <i class="fas fa-link"></i>
          <span>Connected to ${currentNetwork} (${currentAccount.substring(0,6)}...${currentAccount.substring(38)})</span>
        `;
      } else {
        statusEl.className = 'connection-status disconnected';
        statusEl.innerHTML = `
          <i class="fas fa-unlink"></i>
          <span>Disconnected</span>
        `;
      }
    }

    // Get network name from chain ID
    function getNetworkName(chainId) {
      const id = typeof chainId === 'string' ? parseInt(chainId, 16) : chainId;
      
      switch(id) {
        case 1: return 'Ethereum Mainnet';
        case 56: return 'Binance Smart Chain';
        case 97: return 'BSC Testnet';
        case 137: return 'Polygon Mainnet';
        default: return `Chain ID ${id}`;
      }
    }

    // Fetch token prices from CoinGecko API
    async function fetchTokenPrices() {
      try {
        // For demo purposes, we'll use mock prices
        tokenPrices = {
          'bnb': 300.50,
          'ethereum': 1800.25,
          'supremeamer': 0.00015,
          'tether': 1.00,
          'usd-coin': 1.00,
          'binance-usd': 1.00
        };
        
        // In a real implementation, you would use:
        // const response = await axios.get('https://api.coingecko.com/api/v3/simple/price?ids=binancecoin,ethereum,tether,usd-coin,binance-usd&vs_currencies=usd');
        // tokenPrices = response.data;
        
        showNotification("Token prices updated", "success");
        
        // Update UI if on home page
        if (document.getElementById('assets-list')) {
          renderAssets();
        }
        
      } catch (error) {
        console.error("Error fetching token prices:", error);
        showNotification("Failed to fetch token prices", "error");
      }
    }

    // Fetch token balances for connected wallet
    async function fetchBalances() {
      if (!currentAccount || !web3) return;
      
      try {
        // Clear previous balances
        tokenBalances = {};
        
        // Get native balance (BNB)
        const nativeBalance = await web3.eth.getBalance(currentAccount);
        tokenBalances['BNB'] = web3.utils.fromWei(nativeBalance, 'ether');
        
        // Get token balances
        for (const token of TOKEN_LIST) {
          if (token.contract === 'BNB') continue; // Skip native token
          
          try {
            // Create token contract instance
            const tokenContract = new web3.eth.Contract(
              [
                {
                  "constant": true,
                  "inputs": [{"name": "_owner", "type": "address"}],
                  "name": "balanceOf",
                  "outputs": [{"name": "balance", "type": "uint256"}],
                  "type": "function"
                },
                {
                  "constant": true,
                  "inputs": [],
                  "name": "decimals",
                  "outputs": [{"name": "", "type": "uint8"}],
                  "type": "function"
                }
              ],
              token.contract
            );
            
            // Get balance
            const balance = await tokenContract.methods.balanceOf(currentAccount).call();
            const decimals = await tokenContract.methods.decimals().call();
            
            // Convert to human-readable amount
            tokenBalances[token.symbol] = balance / (10 ** decimals);
          } catch (err) {
            console.error(`Error fetching balance for ${token.symbol}:`, err);
            tokenBalances[token.symbol] = '0';
          }
        }
        
        showNotification("Balances updated", "success");
        
        // Update UI if on home page
        if (document.getElementById('assets-list')) {
          renderAssets();
        }
        
      } catch (error) {
        console.error("Error fetching balances:", error);
        showNotification("Failed to fetch balances", "error");
      }
    }

    // Withdraw mined tokens to connected wallet
    async function withdrawMinedTokens() {
      if (!currentAccount) {
        showNotification("Please connect a wallet first", "error");
        return;
      }
      
      if (minedCoins <= 0) {
        showNotification("No tokens to withdraw", "error");
        return;
      }
      
      try {
        // In a real implementation, this would call your smart contract
        // For now, we'll simulate the withdrawal
        showNotification(`Withdrawing ${minedCoins.toFixed(4)} SA to ${currentAccount.substring(0,6)}...${currentAccount.substring(38)}`, "info");
        
        // Simulate transaction hash
        const txHash = '0x' + Math.random().toString(16).substr(2, 64);
        
        // Reset mined coins
        minedCoins = 0;
        localStorage.setItem('minedCoins', '0');
        
        // Update UI
        updateMiningUI();
        updateMiningStats();
        if (document.getElementById('assets-list')) {
          renderAssets();
        }
        
        showNotification(`Success! Transaction: ${txHash.substring(0,10)}...`, "success");
        
      } catch (error) {
        console.error("Withdrawal error:", error);
        showNotification("Withdrawal failed", "error");
      }
    }

    // Wallet Management UI
    function renderWallets() {
      const el = document.getElementById('wallets-list');
      if (!el) return;
      el.innerHTML = wallets.map((w,i) => `
        <div class="token-row">
          <div>
            <b>${w.name || 'Wallet '+(i+1)}</b><br>
            <small>${w.address ? w.address.substring(0,6) + '...' + w.address.substring(38) : 'New Wallet'}</small>
          </div>
          <span>
            <button class="action" style="padding: 6px 12px;" onclick="setActiveWallet(${i})">
              ${activeWallet===w ? '<i class="fas fa-check"></i> Active' : 'Set Active'}
            </button>
          </span>
        </div>
      `).join('');
    }
    
    function setActiveWallet(i) {
      activeWallet = wallets[i];
      localStorage.setItem('supremeamer_wallet_active', i);
      showNotification(`Wallet ${i+1} set as active`, "success");
      showSection('home');
    }
    
    function createWalletUI() {
      const seed = generateSeedPhrase();
      const name = prompt('Wallet name?');
      if (name) {
        const wallet = { 
          name, 
          seed,
          address: generateAddressFromSeed(seed)
        };
        wallets.push(wallet);
        activeWallet = wallet;
        localStorage.setItem('supremeamer_wallets', JSON.stringify(wallets));
        showNotification("Wallet created successfully!", "success");
        showSection('home');
      }
    }
    
    function importWalletUI() {
      const seed = prompt('Enter your 12-word seed phrase:');
      if (validateSeedPhrase(seed)) {
        const name = prompt('Wallet name?');
        if (name) {
          const wallet = { 
            name, 
            seed,
            address: generateAddressFromSeed(seed)
          };
          wallets.push(wallet);
          activeWallet = wallet;
          localStorage.setItem('supremeamer_wallets', JSON.stringify(wallets));
          showNotification("Wallet imported successfully!", "success");
          showSection('home');
        }
      } else {
        showNotification("Invalid seed phrase", "error");
      }
    }
    
    function generateSeedPhrase() {
      // Simple 12-word mnemonic (not BIP39, for demo only!)
      const words = 'apple banana cherry dog eagle fox goat house iron jar kite lemon mango nest orange pear queen river star tree umbrella violet whale xray yellow zebra'.split(' ');
      let arr = [];
      for (let i=0;i<12;i++) arr.push(words[Math.floor(Math.random()*words.length)]);
      return arr.join(' ');
    }
    
    function validateSeedPhrase(seed) {
      return seed && seed.split(' ').length === 12;
    }
    
    function generateAddressFromSeed(seed) {
      // Simple hash function to generate a mock address from seed
      let hash = 0;
      for (let i = 0; i < seed.length; i++) {
        hash = ((hash << 5) - hash) + seed.charCodeAt(i);
        hash |= 0; // Convert to 32bit integer
      }
      return '0x' + Math.abs(hash).toString(16).substring(0, 40);
    }

    // Asset List
    function renderAssets() {
      const el = document.getElementById('assets-list');
      if (!el) return;
      
      el.innerHTML = TOKEN_LIST.map(token => {
        const balance = tokenBalances[token.symbol] || (token.symbol === 'SA' ? minedCoins.toFixed(4) : '0');
        const price = tokenPrices[token.symbol.toLowerCase()] || 0;
        const value = (parseFloat(balance) * price).toFixed(2);
        
        return `
          <div class="token-row">
            <span style="display: flex; align-items: center;">
              <img src="${token.logo}" style="width: 24px; height: 24px; margin-right: 10px; border-radius: 50%;">
              <div>
                <b>${token.symbol}</b> (${token.name})
                <br><small>$${price} per ${token.symbol}</small>
              </div>
            </span>
            <span style="text-align: right;">
              <div class="balance">${parseFloat(balance).toFixed(4)}</div>
              <small>$${value}</small>
            </span>
          </div>
          <hr>
        `;
      }).join('');
    }

    // Mining Functions
    function loadMiningState() {
      // Load mining state from localStorage
      if (localStorage.getItem('minedCoins')) {
        minedCoins = parseFloat(localStorage.getItem('minedCoins'));
      }
      
      if (localStorage.getItem('miningActive') === 'true') {
        miningActive = true;
      }
    }
    
    function startMining() {
      if (miningActive) {
        stopMining();
        return;
      }
      
      miningActive = true;
      localStorage.setItem('miningActive', 'true');
      
      // Start mining interval
      miningInterval = setInterval(() => {
        minedCoins += miningSpeed;
        localStorage.setItem('minedCoins', minedCoins);
        
        // Update UI
        updateMiningUI();
        updateMiningStats();
        
        // Update assets list if on home page
        if (document.getElementById('assets-list')) {
          renderAssets();
        }
      }, 1000);
      
      showNotification("Mining started!", "success");
      updateMiningUI();
    }
    
    function stopMining() {
      miningActive = false;
      clearInterval(miningInterval);
      localStorage.setItem('miningActive', 'false');
      showNotification("Mining stopped", "info");
      updateMiningUI();
    }
    
    function updateMiningUI() {
      const toggleBtn = document.getElementById('mining-toggle-btn');
      const toggleBtnFull = document.getElementById('mining-toggle-btn-full');
      const statusDisplay = document.getElementById('mining-status-display');
      const progressBar = document.getElementById('mining-progress');
      const progressBarFull = document.getElementById('mining-progress-full');
      const miningStats = document.getElementById('mining-stats');
      
      if (toggleBtn) {
        toggleBtn.innerHTML = miningActive ? 
          '<i class="fas fa-power-off"></i> Stop Mining' : 
          '<i class="fas fa-power-off"></i> Start Mining';
      }
      
      if (toggleBtnFull) {
        toggleBtnFull.innerHTML = miningActive ? 
          '<i class="fas fa-power-off"></i> Stop Mining' : 
          '<i class="fas fa-power-off"></i> Start Mining';
      }
      
      if (statusDisplay) {
        statusDisplay.innerHTML = miningActive ? 
          '<div class="mining-active"><i class="fas fa-check-circle"></i> Mining Active</div>' : 
          '<div class="mining-inactive"><i class="fas fa-times-circle"></i> Mining Inactive</div>';
      }
      
      if (progressBar) {
        // Simple progress animation for demo
        progressBar.style.width = miningActive ? '100%' : '0%';
      }
      
      if (progressBarFull) {
        progressBarFull.style.width = miningActive ? '100%' : '0%';
      }
      
      if (miningStats) {
        miningStats.innerHTML = `Mined: ${minedCoins.toFixed(4)} SA | Speed: ${miningSpeed} SA/sec`;
      }
    }
    
    function updateMiningStats() {
      const statsDisplay = document.getElementById('mining-stats-display');
      const upgradeSection = document.getElementById('mining-upgrade-section');
      
      if (statsDisplay) {
        statsDisplay.innerHTML = `
          <p>Total Mined: <b>${minedCoins.toFixed(4)} SA</b></p>
          <p>Current Speed: <b>${miningSpeed} SA/sec</b></p>
          <p>Status: <b>${miningActive ? 'Active' : 'Inactive'}</b></p>
        `;
      }
      
      if (upgradeSection) {
        upgradeSection.innerHTML = `
          <h3><i class="fas fa-bolt"></i> Upgrade Mining Speed</h3>
          <p>Increase your mining speed with these upgrades:</p>
          
          <div class="card">
            <h4>ðŸš€ 0.05 SA/sec</h4>
            <p>Duration: 360 days</p>
            <p>Fee: 0.002 BNB</p>
            <button class="action" onclick="upgradeMining(0.05, 0.002)">
              Upgrade Now
            </button>
          </div>
          
          <div class="card">
            <h4>ðŸ”¥ 0.1 SA/sec</h4>
            <p>Duration: 360 days</p>
            <p>Fee: 0.009 BNB</p>
            <button class="action" onclick="upgradeMining(0.1, 0.009)">
              Upgrade Now
            </button>
          </div>
        `;
      }
    }
    
    function upgradeMining(speed, fee) {
      if (!currentAccount) {
        showNotification("Please connect a wallet first", "error");
        return;
      }
      
      if (confirm(`Upgrade your mining speed to ${speed} SA/sec for 360 days?\n\nCost: ${fee} BNB`)) {
        // In a real app, this would send a transaction
        miningSpeed = speed;
        
        showNotification(`Mining speed upgraded to ${speed} SA/sec!`, "success");
        updateMiningUI();
        updateMiningStats();
      }
    }

    // Staking Tab
    function renderStakingForm() {
      const el = document.getElementById('staking-form');
      if (!el) return;
      el.innerHTML = `
        <form onsubmit="event.preventDefault();calcStakingReward();">
          <label>Asset:
            <select id="stake-asset">
              ${TOKEN_LIST.map(t => `<option value="${t.symbol}">${t.symbol}</option>`).join('')}
            </select>
          </label>
          <label>Amount ($):
            <input type="number" id="stake-amount" min="1" required>
          </label>
          <label>Duration:
            <select id="stake-duration">
              <option value="30">30 Days</option>
              <option value="62">62 Days</option>
              <option value="365">1 Year</option>
            </select>
          </label>
          <button type="submit" class="action">
            <i class="fas fa-calculator"></i> Calculate Reward
          </button>
        </form>
      `;
    }
    
    function calcStakingReward() {
      const asset = document.getElementById('stake-asset').value;
      const amount = parseFloat(document.getElementById('stake-amount').value);
      const duration = parseInt(document.getElementById('stake-duration').value);
      
      // Per your formula: $3 stake = 3,000,000 tokens, reward 8% annual. Linear scale.
      const tokensStaked = (amount / 3) * 3000000;
      const durationFraction = duration / 365;
      const reward = tokensStaked * durationFraction * 0.08;
      
      document.getElementById('staking-summary').innerHTML = `
        <div class="card">
          <h3>Staking Summary</h3>
          <p><b>Staked:</b> ${tokensStaked.toLocaleString()} tokens</p>
          <p><b>Reward:</b> ${reward.toLocaleString(undefined,{maximumFractionDigits:2})} SupremeAmer tokens</p>
          <p><b>Profit:</b> $${(reward/3000000*3).toFixed(4)}</p>
          <button class="action" onclick="stakeTokens()">
            <i class="fas fa-lock"></i> Stake Now
          </button>
        </div>
      `;
    }
    
    function stakeTokens() {
      showNotification("Staking transaction submitted!", "success");
    }

    // DEX Tab
    function renderDexForm() {
      const el = document.getElementById('dex-form');
      if (!el) return;
      el.innerHTML = `
        <form onsubmit="event.preventDefault();performSwap();">
          <div style="display: flex; gap: 10px;">
            <div style="flex: 1;">
              <label>From:
                <select id="dex-from-asset">
                  ${TOKEN_LIST.map(t => `<option value="${t.symbol}">${t.symbol}</option>`).join('')}
                </select>
              </label>
              <label>Amount:
                <input type="number" id="dex-from-amount" min="0.01" step="0.01" required>
              </label>
            </div>
            
            <div style="flex: 1;">
              <label>To:
                <select id="dex-to-asset">
                  ${TOKEN_LIST.map(t => `<option value="${t.symbol}">${t.symbol}</option>`).join('')}
                </select>
              </label>
              <label>Estimated:
                <input type="text" id="dex-to-amount" readonly>
              </label>
            </div>
          </div>
          
          <button type="submit" class="action">
            <i class="fas fa-exchange-alt"></i> Swap Tokens
          </button>
        </form>
      `;
      
      // Add event listeners for live calculation
      document.getElementById('dex-from-amount').addEventListener('input', calculateSwap);
      document.getElementById('dex-from-asset').addEventListener('change', calculateSwap);
      document.getElementById('dex-to-asset').addEventListener('change', calculateSwap);
      
      // Initial calculation
      calculateSwap();
    }
    
    function calculateSwap() {
      const fromAsset = document.getElementById('dex-from-asset').value;
      const toAsset = document.getElementById('dex-to-asset').value;
      const amount = parseFloat(document.getElementById('dex-from-amount').value) || 0;
      
      // Simple conversion rates for demo
      let rate = 1;
      if (fromAsset === 'SA' && toAsset === 'BNB') rate = 0.0001;
      if (fromAsset === 'BNB' && toAsset === 'SA') rate = 10000;
      if (fromAsset === 'SA' && toAsset === 'USDT') rate = 0.00015;
      if (fromAsset === 'USDT' && toAsset === 'SA') rate = 6666.67;
      
      document.getElementById('dex-to-amount').value = (amount * rate).toFixed(6);
    }
    
    function performSwap() {
      const fromAsset = document.getElementById('dex-from-asset').value;
      const toAsset = document.getElementById('dex-to-asset').value;
      const amount = parseFloat(document.getElementById('dex-from-amount').value);
      const estimated = document.getElementById('dex-to-amount').value;
      
      if (!currentAccount) {
        showNotification("Please connect a wallet first", "error");
        return;
      }
      
      if (confirm(`Swap ${amount} ${fromAsset} for ~${estimated} ${toAsset}?`)) {
        showNotification("Swap transaction submitted!", "success");
      }
    }

    // Settings
    function setPINUI() {
      const pin = prompt('Enter a 4-digit PIN:');
      if (/^\d{4}$/.test(pin)) {
        localStorage.setItem('supremeamer_wallet_pin', pin);
        showNotification("PIN set successfully!", "success");
      } else {
        showNotification("Invalid PIN. Must be 4 digits.", "error");
      }
    }
    
    function backupCloudUI() {
      showNotification("Cloud backup with Appwrite: integration required", "info");
    }
    
    function exportSeedUI() {
      if (activeWallet) {
        prompt('Your seed phrase (keep this secret!):', activeWallet.seed);
      } else {
        showNotification("No active wallet", "error");
      }
    }
    
    // Copy to clipboard
    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(() => {
        showNotification("Copied to clipboard!", "success");
      }).catch(err => {
        console.error('Failed to copy: ', err);
        showNotification("Failed to copy", "error");
      });
    }

    // PIN lock (basic)
    (function(){
      const pin = localStorage.getItem('supremeamer_wallet_pin');
      if (pin) {
        let entered = prompt('Enter your PIN to unlock SupremeAmer Wallet:');
        if (entered !== pin) {
          alert('Incorrect PIN. Reload to try again.');
          document.body.innerHTML = '';
        }
      }
    })();
  </script>
  <!-- QR Code Library -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SupremeAmer Coin Airdrop</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;400&display=swap" rel="stylesheet">
    <style>
        /* Keep your original CSS from before */
        body { font-family: 'Montserrat', Arial, sans-serif; min-height: 100vh; margin: 0; background: linear-gradient(135deg, #111 70%, #ff9800 100%); color: #fff; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .header { width: 100%; padding: 25px 0 10px 0; text-align: center; background: rgba(0,0,0,0.7); font-size: 2.4em; font-weight: bold; letter-spacing: 2px; box-shadow: 0 2px 16px #ffeb3b33; }
        .marquee { background: linear-gradient(90deg, #ff9800, #fdc500, #ff9800); color: #222; font-size: 1.2em; padding: 8px 0; margin-bottom: 18px; border-radius: 0 0 16px 16px; white-space: nowrap; overflow: hidden; position: relative; height: 1.5em; }
        .marquee-text { display: inline-block; position: absolute; left: 100%; animation: marquee 15s linear infinite; white-space: nowrap; will-change: transform; }
        @keyframes marquee { 0% { transform: translateX(0%);} 100% { transform: translateX(-100vw);} }
        .container { background: rgba(30, 30, 40, 0.95); padding: 36px 32px 28px 32px; border-radius: 20px; box-shadow: 0 8px 32px #0006; text-align: center; max-width: 400px; width: 90%; }
        .mined-coins { font-size: 2.3em; margin: 14px 0; color: #ffb900; font-weight: 700; letter-spacing: 1px; }
        .timer { font-size: 1.5em; color: #ff3333; margin-bottom: 18px; font-weight: 600; }
        .mine-btn, .upgrade-btn, .reward-btn, .boost-btn { padding: 15px 38px; background: linear-gradient(90deg, #fdc500 40%, #ff9800 100%); color: #111; border: none; border-radius: 8px; font-size: 1.2em; font-weight: bold; cursor: pointer; transition: box-shadow 0.2s, background 0.2s; box-shadow: 0 4px 16px #ff980066; margin-bottom: 10px; }
        .mine-btn:hover, .upgrade-btn:hover, .reward-btn:hover, .boost-btn:hover { background: linear-gradient(90deg, #ff9800 40%, #fdc500 100%); box-shadow: 0 8px 24px #ff980099; }
        .upgrade-btn[disabled], .reward-btn[disabled], .boost-btn[disabled] { opacity: 0.65; cursor: not-allowed; }
        .ref-container { margin: 12px 0 6px 0; }
        #leaderboard { margin: 14px 0 0 0; background:rgba(20,20,20,0.35); border-radius:10px; padding:10px; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/appwrite@13.0.0"></script>
</head>
<body>
    <div class="header">SUPREMEAMER COIN AIRDROP ðŸš€ðŸ’°</div>
    <div class="marquee">
        <span class="marquee-text">Welcome to $SA - Mine SupremeAmer coins and join the revolution! ðŸš€ðŸ’°ðŸŽ‰</span>
    </div>
    <div class="container">
        <div style="font-size:1.5em; color:#fdc500; margin-bottom:6px;">Mining Dashboard</div>
        <div class="upgrade-info" id="upgradeInfo"></div>
        <div class="mined-coins" id="minedCoins">Mined Coins: 0</div>
        <div class="timer" id="timer">07:00:00</div>
        <button class="mine-btn" id="mineBtn">Start Mining</button><br>
        <button class="upgrade-btn" id="upgradeBtn">âš¡ Speed Upgrade: 10 coins/sec Â· 30 days ($9.5 in ETH)</button>
        <button class="reward-btn" id="rewardBtn">Claim Daily Reward</button>
        <button class="boost-btn" id="boostBtn">Buy 1hr Boost (50 coins)</button>
        <div class="ref-container">
            <div><small>Your Referral Link:</small></div>
            <input type="text" id="refLink" readonly style="width:95%">
            <button onclick="navigator.clipboard.writeText(document.getElementById('refLink').value)">Copy</button>
        </div>
        <div id="leaderboard"></div>
    </div>

    <script>
    // --- Appwrite Setup ---
    const client = new Appwrite.Client()
        .setEndpoint('https://fra.cloud.appwrite.io/v1') // Replace with your endpoint
        .setProject('6839d9640019316a160d'); // Replace with your project ID

    const account = new Appwrite.Account(client);
    const databases = new Appwrite.Databases(client);

    // --- Collection IDs (replace if different in your Appwrite project) ---
    const DB_ID = '6839dcca000190bf99f6';
    const USERS_COLL = 'users';
    const REFERRALS_COLL = 'referrals';
    const DAILY_COLL = 'daily_rewards';
    const BOOSTS_COLL = 'boosts';

    // --- Mining Parameters ---
    const NORMAL_SPEED = 0.07;
    const UPGRADE_SPEED = 10;
    const BOOST_MULTIPLIER = 1.5;
    const BOOST_COST = 50;
    const BOOST_DURATION_MS = 3600 * 1000; // 1 hour

    // --- State ---
    let userId = null;
    let miningInterval = null;
    let miningActive = false;
    let minedCoins = 0;
    let upgradeActive = false;
    let upgradeEnd = 0;
    let miningSpeed = NORMAL_SPEED;

    // --- Utility ---
    function padZero(v) { return String(v).padStart(2, '0'); }
    function formatTime(sec) {
        const h = Math.floor(sec / 3600);
        const m = Math.floor((sec % 3600) / 60);
        const s = sec % 60;
        return `${padZero(h)}:${padZero(m)}:${padZero(s)}`;
    }

    // --- Referral System ---
    function generateReferralLink(userId) {
        return `${window.location.origin + window.location.pathname}?ref=${userId}`;
    }
    async function createReferralIfNeeded(newUserId) {
        const params = new URLSearchParams(window.location.search);
        const ref = params.get('ref');
        if (ref && ref !== newUserId) {
            // Store referral in its own collection
            try {
                await databases.createDocument(DB_ID, REFERRALS_COLL, Appwrite.ID.unique(), {
                    referrer_user_id: ref,
                    referred_user_id: newUserId,
                    bonus_claimed: false
                });
            } catch (e) {
                // Ignore if already exists
            }
        }
    }
    // Call this when a referred user finishes their first mining session
    async function claimReferralBonusIfNeeded() {
        // Find the referral doc
        const res = await databases.listDocuments(DB_ID, REFERRALS_COLL, [
            Appwrite.Query.equal('referred_user_id', [userId]),
            Appwrite.Query.equal('bonus_claimed', [false])
        ]);
        if (res.documents.length > 0) {
            const referral = res.documents[0];
            // Give bonus coins to referrer
            const referrer = referral.referrer_user_id;
            // Find referrer user doc
            const refUser = await databases.getDocument(DB_ID, USERS_COLL, referrer);
            await databases.updateDocument(DB_ID, USERS_COLL, referrer, {
                mined_coins: (refUser.mined_coins || 0) + 10 // Example bonus
            });
            // Mark referral bonus as claimed
            await databases.updateDocument(DB_ID, REFERRALS_COLL, referral.$id, { bonus_claimed: true });
            alert("Your referrer has received a bonus! ðŸŽ‰");
        }
    }

    // --- Daily Rewards ---
    async function claimDailyReward() {
        const today = new Date().toISOString().split('T')[0];
        let rewardData;
        try {
            rewardData = await databases.getDocument(DB_ID, DAILY_COLL, userId);
        } catch {
            // No doc yet
        }

        if (rewardData && rewardData.last_claim_date === today) {
            alert("You have already claimed today's reward!");
            return;
        }
        // Update streak
        let newStreak = 1;
        if (rewardData && rewardData.last_claim_date) {
            const lastDate = new Date(rewardData.last_claim_date);
            const diff = (new Date(today) - lastDate) / (1000 * 60 * 60 * 24);
            if (diff === 1) newStreak = rewardData.streak_count + 1;
        }
        await databases.createDocument(DB_ID, DAILY_COLL, userId, {
            user_id: userId,
            last_claim_date: today,
            streak_count: newStreak
        }).catch(async () => {
            await databases.updateDocument(DB_ID, DAILY_COLL, userId, {
                last_claim_date: today,
                streak_count: newStreak
            });
        });
        await addCoins(userId, newStreak * 10); // Reward increases with streak
        alert(`Daily reward claimed! +${newStreak * 10} coins (streak: ${newStreak} days)`);
        updateCoinsDisplay();
        showLeaderboard();
    }

    // --- Mining Boosts ---
    async function buyBoost() {
        const user = await getUser();
        if (user.mined_coins < BOOST_COST) {
            alert("Not enough coins.");
            return;
        }
        const expiresAt = new Date(Date.now() + BOOST_DURATION_MS).toISOString();
        await databases.createDocument(DB_ID, BOOSTS_COLL, Appwrite.ID.unique(), {
            user_id: userId,
            boost_type: "speed",
            expires_at: expiresAt
        });
        await addCoins(userId, -BOOST_COST);
        alert("Boost purchased! +50% mining rate for 1 hour.");
        updateCoinsDisplay();
    }
    async function getActiveBoost() {
        const nowIso = new Date().toISOString();
        const res = await databases.listDocuments(DB_ID, BOOSTS_COLL, [
            Appwrite.Query.equal('user_id', [userId]),
            Appwrite.Query.greaterThan('expires_at', nowIso)
        ]);
        return res.documents.length > 0;
    }

    // --- Leaderboard ---
    async function getLeaderboard() {
        const res = await databases.listDocuments(DB_ID, USERS_COLL, [
            Appwrite.Query.orderDesc('mined_coins'),
            Appwrite.Query.limit(10)
        ]);
        return res.documents;
    }
    async function showLeaderboard() {
        const data = await getLeaderboard();
        document.getElementById('leaderboard').innerHTML =
            '<h3>Leaderboard</h3><ol>' +
            data.map(u => `<li>${u.user_id?.slice(0, 6) || ''}... â€” <b>${u.mined_coins || 0}</b> coins</li>`).join('') +
            '</ol>';
    }

    // --- Users & Coins ---
    async function getUser() {
        return await databases.getDocument(DB_ID, USERS_COLL, userId);
    }
    async function addCoins(userId, amount) {
        const user = await getUser();
        await databases.updateDocument(DB_ID, USERS_COLL, userId, {
            mined_coins: (user.mined_coins || 0) + amount
        });
    }
    async function updateCoinsDisplay() {
        const user = await getUser();
        minedCoins = user.mined_coins || 0;
        document.getElementById('minedCoins').textContent = `Mined Coins: ${minedCoins}`;
    }

    // --- Mining Logic ---
    async function getMiningRate() {
        let speed = NORMAL_SPEED;
        // Check for upgrade (implement as needed)
        // Example: if (upgradeActive) speed = UPGRADE_SPEED;
        if (await getActiveBoost()) speed *= BOOST_MULTIPLIER;
        return speed;
    }
    async function startMining() {
        if (miningActive) return;
        miningActive = true;
        miningInterval = setInterval(async () => {
            const speed = await getMiningRate();
            await addCoins(userId, speed);
            updateCoinsDisplay();
        }, 1000);
        // On first mining session after registration, check referral milestone
        claimReferralBonusIfNeeded();
    }
    function stopMining() {
        miningActive = false;
        clearInterval(miningInterval);
    }

    // --- UI Handlers ---
    document.getElementById('mineBtn').onclick = startMining;
    document.getElementById('rewardBtn').onclick = claimDailyReward;
    document.getElementById('boostBtn').onclick = buyBoost;

    // --- On Load: Auth, UI, Referrals ---
    (async () => {
        let session;
        try {
            session = await account.get();
        } catch {
            await account.createAnonymousSession();
            session = await account.get();
        }
        userId = session.$id;

        // Ensure user doc exists
        try {
            await databases.getDocument(DB_ID, USERS_COLL, userId);
        } catch {
            await databases.createDocument(DB_ID, USERS_COLL, userId, {
                user_id: userId,
                mined_coins: 0
            });
        }
        // Referral
        await createReferralIfNeeded(userId);
        // Populate referral link
        document.getElementById('refLink').value = generateReferralLink(userId);

        // Initial UI update
        await updateCoinsDisplay();
        await showLeaderboard();
    })();

    </script>
</body>
</html>

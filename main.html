<script>
// ------------ Appwrite Setup ------------
const appwrite = new Appwrite.Client()
    .setEndpoint('https://[YOUR_APPWRITE_ENDPOINT]') // <-- CHANGE ME
    .setProject('[YOUR_PROJECT_ID]'); // <-- CHANGE ME

const account = new Appwrite.Account(appwrite);
const databases = new Appwrite.Databases(appwrite);  

const DB_ID = '[YOUR_DB_ID]'; // <-- CHANGE ME
const USER_COLL_ID = 'users'; // User data collection
const LB_COLL_ID = 'leaderboard'; // Leaderboard collection

let currentUser = null;

// --- User Authentication (Anonymous for demo, use proper auth in prod) ---
async function loginOrRegister() {
    try {
        currentUser = await account.get();
    } catch (err) {
        // Not logged in, create anonymous session
        await account.createAnonymousSession();
        currentUser = await account.get();
        // Create user doc in DB if new
        await databases.createDocument(DB_ID, USER_COLL_ID, currentUser.$id, {
            minedCoins: 0,
            lastDaily: 0,
            referrals: [],
            streak: 0
        });
    }
}
await loginOrRegister();

const userId = currentUser.$id;

// ------------ Referral System --------------
// Each user gets a referral link: ?ref=USERID
function getReferralLink() {
    return `${window.location.origin + window.location.pathname}?ref=${userId}`;
}
function handleReferral() {
    const ref = new URLSearchParams(window.location.search).get('ref');
    if(ref && ref !== userId) {
        // Give referrer a bonus
        databases.getDocument(DB_ID, USER_COLL_ID, ref)
        .then(doc => {
            let newRefs = (doc.referrals || []);
            if(!newRefs.includes(userId)) {
                newRefs.push(userId);
                // Add bonus coins to referrer
                databases.updateDocument(DB_ID, USER_COLL_ID, ref, {
                    referrals: newRefs,
                    minedCoins: (doc.minedCoins || 0) + 10 // +10 coins per referral
                });
            }
        });
    }
}
handleReferral();

// ------------ Daily Rewards --------------
async function claimDailyReward() {
    const userDoc = await databases.getDocument(DB_ID, USER_COLL_ID, userId);
    const now = Math.floor(Date.now() / 1000);
    const lastDaily = userDoc.lastDaily || 0;
    let streak = userDoc.streak || 0;
    if(now - lastDaily >= 86400) { // 24h
        streak = (now - lastDaily < 2 * 86400) ? streak + 1 : 1;
        const dailyCoins = 5 + streak; // bonus grows with streak
        await databases.updateDocument(DB_ID, USER_COLL_ID, userId, {
            minedCoins: userDoc.minedCoins + dailyCoins,
            lastDaily: now,
            streak
        });
        alert(`Daily reward claimed! +${dailyCoins} coins (streak: ${streak} days)`);
        updateMinedCoinsDisplay();
    } else {
        alert('Already claimed daily reward. Come back tomorrow!');
    }
}

// ------------ Mining Boosts --------------
async function buyMiningBoost() {
    // For demo: +5 coins/sec, lasts 1 hour, cost 50 coins
    const userDoc = await databases.getDocument(DB_ID, USER_COLL_ID, userId);
    if(userDoc.minedCoins < 50) {
        alert('Not enough coins for boost.');
        return;
    }
    await databases.updateDocument(DB_ID, USER_COLL_ID, userId, {
        minedCoins: userDoc.minedCoins - 50,
        boostUntil: Math.floor(Date.now() / 1000) + 3600 // 1 hour from now
    });
    alert('Boost purchased! +5 coins/sec for 1 hour.');
    // update mining logic to check boostUntil
}

function getUserMiningSpeed(userDoc) {
    const now = Math.floor(Date.now() / 1000);
    let speed = NORMAL_SPEED;
    if (userDoc.boostUntil && userDoc.boostUntil > now) speed += 5; // add boost
    if (userDoc.upgradeActive && userDoc.upgradeEndTimestamp > now) speed = UPGRADE_SPEED;
    return speed;
}

// ------------ Leaderboard --------------
async function showLeaderboard() {
    const result = await databases.listDocuments(DB_ID, USER_COLL_ID, [
        Appwrite.Query.orderDesc('minedCoins'),
        Appwrite.Query.limit(10)
    ]);
    let html = '<h3>Leaderboard</h3><ol>';
    result.documents.forEach((u, i) => {
        html += `<li>User: ${u.$id.substring(0,6)}..., Coins: ${u.minedCoins || 0}</li>`;
    });
    html += '</ol>';
    document.getElementById('leaderboard').innerHTML = html;
}

// ------------ Update Display --------------
async function updateMinedCoinsDisplay() {
    const userDoc = await databases.getDocument(DB_ID, USER_COLL_ID, userId);
    document.getElementById('minedCoins').textContent = `Mined Coins: ${userDoc.minedCoins.toFixed(4)}`;
}

window.onload = async function() {
    await loginOrRegister();
    await updateMinedCoinsDisplay();
    await showLeaderboard();
    // ...rest of your logic
};

// Add UI buttons for new features:
</script>

<div class="container">
    <!-- ...existing dashboard UI... -->
    <button onclick="claimDailyReward()">Claim Daily Reward</button>
    <button onclick="buyMiningBoost()">Buy Mining Boost (50 coins)</button>
    <div>
        <span>Your Referral Link:</span>
        <input type="text" id="refLink" readonly style="width:95%">
        <button onclick="navigator.clipboard.writeText(document.getElementById('refLink').value)">Copy</button>
    </div>
    <div id="leaderboard"></div>
</div>
<script>
document.getElementById('refLink').value = getReferralLink();
</script>
